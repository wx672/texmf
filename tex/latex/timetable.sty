\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{timetable}

\RequirePackage{ifxetex} % This class is for XeTeX only

\RequirePackage[scheme=plain]{ctex}

\usetikzlibrary{calc,positioning,patterns,chains}

\newcommand{\Term}[1]{\gdef\TT@Term{#1}}
\newcommand{\Teacher}[1]{\gdef\TT@Teacher{#1}}

%%%
% #1 - (optional)
% #2 - lecture/lab/office
% #3 - (day,time)
% #4 - course name
% #5 - weeks
% #6 - room
\newcommand{\class}[6][5/3]{%
  \node[#2,minimum height=#1*\hourlength] at (#3) {#4\\{\scriptsize #5}\\{\small #6}};%
}%

\newcommand{\daywidth}{5cm}%
\newcommand{\hourlength}{1cm}%

\tikzset{%
  help lines/.style={very thin,dotted},%
  day/.style={on chain,rectangle, fill=gray!20,%
    minimum width=\daywidth, minimum height=2ex, node font=\bfseries\Large},%
  class/.style={rectangle, anchor=north west, rounded corners=10pt,%
    minimum width=.99*\daywidth,% minimum height=5/3*\hourlength,
    align=center, text width=.99*\daywidth},%
  lecture/.style={class, fill=red!30},%
  lab/.style={class, fill=Green!20},%
  lecturelab/.style={class, left color=red!30,right color=Green!20},%
  office/.style={class, fill=gray!30},%
  done/.style={class,pattern color=black!50,pattern=north east lines}%
}%

\newenvironment{timetable}
{%
  \begin{tikzpicture}[start chain,%
    x=\daywidth, y=-\hourlength,%
    node distance=0cm, outer sep=0pt, inner sep=1pt,%
    ]%

    % draw grids
    \draw[help lines] (1,8) grid[xstep=\daywidth,ystep=2*\hourlength] (6,22);%

    % Draw time ticks
    \foreach \h in {8,9,...,22} \draw [ultra thin] (1,\h) -- ++(-5pt,0);% Hours
    \foreach \hh in {8.5,9.5,...,21.5} \draw [ultra thin] (1,\hh) -- ++(-3pt,0);% Half hours

    \foreach \h/\htext in {%
      8/{08:00},9/{09:00},10/{10:00},11/{11:00},12/{12:00},13/{13:00},14/{14:00},15/{15:00},%
      16/{16:00},17/{17:00},18/{18:00},19/{19:00},20/{20:00},21/{21:00},22/{22:00}%,23/{23:00}%
    } \draw [ultra thin] (1,\h) -- ++(-3pt,0) node[left=3pt,font=\scriptsize] {\htext};%

    % Header line (week days)
    \node[day, anchor=south west] at (1,8) {Monday};%
    \node[day, label={85:{Semester: \TT@Term}}] {Tuesday};%
    \node[day, label={12:{\TT@Teacher}}] {Wednesday};%
    \node[day] {Thursday};%
    \node[day] (fri) {Friday};%
  }{%
  \end{tikzpicture}%
}%

